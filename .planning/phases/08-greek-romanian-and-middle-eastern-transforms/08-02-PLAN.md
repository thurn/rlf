---
phase: 08-greek-romanian-and-middle-eastern-transforms
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/rlf/src/interpreter/transforms.rs
  - crates/rlf/tests/interpreter_transforms.rs
autonomous: true

must_haves:
  truths:
    - "Arabic @al prepends definite article with sun letter assimilation"
    - "Arabic @al with :sun tag produces shadda on first consonant"
    - "Arabic @al with :moon tag produces plain al prefix"
    - "Persian @ezafe appends -e (kasra) for consonant-final words"
    - "Persian @ezafe appends -ye for vowel-final words"
  artifacts:
    - path: "crates/rlf/src/interpreter/transforms.rs"
      provides: "ArabicAl, PersianEzafe TransformKind variants"
      contains: "ArabicAl"
    - path: "crates/rlf/tests/interpreter_transforms.rs"
      provides: "Arabic and Persian transform tests"
      contains: "arabic_al"
  key_links:
    - from: "TransformRegistry::get"
      to: "TransformKind::ArabicAl"
      via: "match (\"ar\", \"al\")"
      pattern: "\"ar\".*\"al\".*ArabicAl"
    - from: "TransformRegistry::get"
      to: "TransformKind::PersianEzafe"
      via: "match (\"fa\", \"ezafe\")"
      pattern: "\"fa\".*\"ezafe\".*PersianEzafe"
---

<objective>
Implement Arabic sun/moon letter assimilation transform (@al) and Persian ezafe connector transform (@ezafe).

Purpose: Arabic definite article assimilates before sun letters (shadda). Persian ezafe connects nouns to modifiers with -e or -ye based on word ending.
Output: TransformKind variants for Arabic @al and Persian @ezafe, with Unicode handling for shadda and kasra diacritics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-greek-romanian-and-middle-eastern-transforms/08-CONTEXT.md
@.planning/phases/08-greek-romanian-and-middle-eastern-transforms/08-RESEARCH.md
@crates/rlf/src/interpreter/transforms.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Arabic sun/moon letter assimilation transform</name>
  <files>crates/rlf/src/interpreter/transforms.rs</files>
  <action>
Add Arabic definite article transform with sun/moon letter handling:

1. Add TransformKind::ArabicAl variant

2. Define Unicode constants for Arabic:
   - ALEF_LAM: "\u{0627}\u{0644}" (ال - the definite article)
   - SHADDA: '\u{0651}' (ّ - consonant doubling mark)

3. Implement arabic_al_transform(value):
   Per CONTEXT.md: use :sun/:moon tags (no automatic detection)

   If :sun tag:
   - Sun letters cause assimilation: first letter doubles
   - Get first character of text
   - Output: "ال" + first_char + SHADDA + rest_of_text
   - Example: shams (شمس) with :sun -> الشَّمس (ash-shams)

   If :moon tag:
   - No assimilation, plain prefix
   - Output: "ال" + text
   - Example: qamar (قمر) with :moon -> القمر (al-qamar)

   If neither tag:
   - Return MissingTag error with expected: ["sun", "moon"]

4. Per RESEARCH.md pitfall: shadda goes AFTER the consonant, not before
   Pattern: first_char + shadda (not shadda + first_char)

5. Add to TransformKind::execute match arm

6. Add to TransformRegistry::get:
   - Match: ("ar", "al") => ArabicAl
  </action>
  <verify>cargo check --package rlf</verify>
  <done>ArabicAl transform compiles with proper Unicode handling for shadda</done>
</task>

<task type="auto">
  <name>Task 2: Persian ezafe connector transform</name>
  <files>crates/rlf/src/interpreter/transforms.rs</files>
  <action>
Add Persian ezafe connector transform:

1. Add TransformKind::PersianEzafe variant

2. Define Unicode constants for Persian:
   - KASRA: '\u{0650}' (ِ - short 'e' vowel mark)
   - ZWNJ: "\u{200C}" (zero-width non-joiner)
   - PERSIAN_YE: '\u{06CC}' (ی - Persian ye)

3. Implement persian_ezafe_transform(value):
   Per CONTEXT.md: use :vowel tag to determine word ending

   If :vowel tag (word ends in vowel):
   - Use -ye connector
   - Per RESEARCH.md: include ZWNJ before ye for proper rendering
   - Output: text + ZWNJ + PERSIAN_YE
   - Example: khane (خانه) with :vowel -> خانه‌ی

   If no :vowel tag (word ends in consonant):
   - Use -e (kasra) connector
   - Kasra is placed after the final letter
   - Output: text + KASRA
   - Example: ketab (کتاب) -> کتابِ

4. Note: Persian has no gender system, so no gender tag parsing needed

5. Add to TransformKind::execute match arm

6. Add to TransformRegistry::get:
   - Match: ("fa", "ezafe") => PersianEzafe
  </action>
  <verify>cargo check --package rlf</verify>
  <done>PersianEzafe transform compiles with proper Unicode handling for kasra and ZWNJ</done>
</task>

<task type="auto">
  <name>Task 3: Arabic and Persian integration tests</name>
  <files>crates/rlf/tests/interpreter_transforms.rs</files>
  <action>
Add comprehensive tests for Arabic and Persian transforms:

Arabic @al tests:
- arabic_al_sun_letter: :sun tag -> "ال" + first_char + shadda + rest
- arabic_al_moon_letter: :moon tag -> "ال" + text (no assimilation)
- arabic_al_missing_tag: no tag -> MissingTag error with ["sun", "moon"]
- arabic_al_sun_shadda_position: verify shadda comes AFTER consonant, not before

Persian @ezafe tests:
- persian_ezafe_consonant: no :vowel tag -> text + kasra
- persian_ezafe_vowel: :vowel tag -> text + ZWNJ + ye
- persian_ezafe_kasra_unicode: verify kasra is U+0650
- persian_ezafe_zwnj_unicode: verify ZWNJ is U+200C

Unicode verification tests (byte-level to avoid RTL issues):
- arabic_al_output_bytes: verify exact byte sequence for sun letter output
- persian_ezafe_output_bytes: verify exact byte sequence for ezafe output

Integration tests using Locale:
- arabic_definite_article_in_phrase: Test @al in full phrase evaluation
- persian_ezafe_in_phrase: Test @ezafe connecting words in phrase

Test pattern per RESEARCH.md pitfall: use byte-level comparison or normalize direction marks to avoid RTL text comparison issues.

Run: cargo test --package rlf -- arabic
Run: cargo test --package rlf -- persian
  </action>
  <verify>cargo test --package rlf -- --test-threads=1 2>&1 | tail -20</verify>
  <done>All Arabic and Persian transform tests pass</done>
</task>

</tasks>

<verification>
- cargo check --package rlf passes
- cargo test --package rlf -- arabic passes all Arabic tests
- cargo test --package rlf -- persian passes all Persian tests
- cargo clippy --package rlf passes
- cargo fmt --check passes
</verification>

<success_criteria>
- Arabic @al with :sun tag produces assimilated form with shadda
- Arabic @al with :moon tag produces plain al- prefix
- Persian @ezafe appends kasra for consonant-final words
- Persian @ezafe appends ZWNJ + ye for vowel-final words
- Unicode characters are correctly placed (shadda after consonant, not before)
- All 12+ new tests pass including byte-level Unicode verification
- No regressions in existing transform tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-greek-romanian-and-middle-eastern-transforms/08-02-SUMMARY.md`
</output>
