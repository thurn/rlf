---
phase: 09-asian-language-transforms
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/rlf/Cargo.toml
  - crates/rlf/src/interpreter/transforms.rs
  - crates/rlf/tests/interpreter_transforms.rs
autonomous: true

must_haves:
  truths:
    - "Chinese @count produces number + classifier + noun (e.g., '3张牌')"
    - "Japanese @count produces number + counter + noun (e.g., '3枚カード')"
    - "Korean @count produces number + counter + noun (e.g., '3장카드')"
  artifacts:
    - path: "crates/rlf/src/interpreter/transforms.rs"
      provides: "ChineseCount, JapaneseCount, KoreanCount transforms"
      contains: "ChineseCount"
    - path: "crates/rlf/Cargo.toml"
      provides: "hangeul dependency for Phase 9-03"
      contains: "hangeul"
  key_links:
    - from: "crates/rlf/src/interpreter/transforms.rs"
      to: "TransformRegistry::get"
      via: "language-specific transform registration"
      pattern: "zh.*count|ja.*count|ko.*count"
---

<objective>
Implement @count transforms for Chinese, Japanese, and Korean with classifier/counter systems.

Purpose: Enable counting expressions in CJK languages where classifiers are mandatory (e.g., Chinese "3张牌" not "3牌").
Output: Three working @count transforms with classifier tag support and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-asian-language-transforms/09-RESEARCH.md
@crates/rlf/src/interpreter/transforms.rs
@crates/rlf/src/interpreter/error.rs
@docs/APPENDIX_STDLIB.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hangeul dependency and CJK classifier constants</name>
  <files>crates/rlf/Cargo.toml, crates/rlf/src/interpreter/transforms.rs</files>
  <action>
Add hangeul = "0.4" to Cargo.toml dependencies (needed for Korean @particle in Plan 03).

In transforms.rs, add three new TransformKind variants:
- ChineseCount - @count for zh
- JapaneseCount - @count for ja
- KoreanCount - @count for ko

Add classifier constant arrays based on APPENDIX_STDLIB.md:

Chinese classifiers (CHINESE_CLASSIFIERS):
- zhang -> 张 (flat objects like cards, paper)
- ge -> 个 (general classifier)
- ming -> 名 (people, formal)
- wei -> 位 (people, respectful)
- tiao -> 条 (long thin objects)
- ben -> 本 (books, volumes)
- zhi -> 只 (animals, hands)

Japanese counters (JAPANESE_COUNTERS):
- mai -> 枚 (flat objects)
- nin -> 人 (people)
- hiki -> 匹 (small animals)
- hon -> 本 (long objects)
- ko -> 個 (general small objects)
- satsu -> 冊 (books)

Korean counters (KOREAN_COUNTERS):
- jang -> 장 (flat objects)
- myeong -> 명 (people, formal)
- mari -> 마리 (animals)
- gae -> 개 (general objects)
- gwon -> 권 (books)
  </action>
  <verify>Run `just check` to verify code compiles</verify>
  <done>hangeul dependency added, TransformKind variants defined, classifier arrays defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement CJK @count transform functions</name>
  <files>crates/rlf/src/interpreter/transforms.rs</files>
  <action>
Add helper function to extract count from context:
```rust
fn context_to_count(context: Option<&Value>) -> i64 {
    match context {
        Some(Value::Number(n)) => *n,
        Some(Value::String(s)) => s.parse().unwrap_or(1),
        _ => 1,
    }
}
```

Implement chinese_count_transform:
- Read classifier tag from CHINESE_CLASSIFIERS by checking value.has_tag()
- Get count from context via context_to_count()
- Output: "{count}{classifier}{text}" - number comes FIRST, then classifier, then noun
- Return MissingTag error if no classifier tag found

Implement japanese_count_transform:
- Read counter tag from JAPANESE_COUNTERS
- Get count from context
- Output: "{count}{counter}{text}" - same pattern as Chinese per RESEARCH.md
- Return MissingTag error if no counter tag found

Implement korean_count_transform:
- Read counter tag from KOREAN_COUNTERS
- Get count from context
- Output: "{count}{counter}{text}" - same pattern
- Return MissingTag error if no counter tag found

Wire the transforms in TransformKind::execute() match arm.

Register in TransformRegistry::get():
- ("zh", "count") => Some(TransformKind::ChineseCount)
- ("ja", "count") => Some(TransformKind::JapaneseCount)
- ("ko", "count") => Some(TransformKind::KoreanCount)
  </action>
  <verify>Run `just check` to verify code compiles</verify>
  <done>Three @count transforms implemented and registered</done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for CJK @count transforms</name>
  <files>crates/rlf/tests/interpreter_transforms.rs</files>
  <action>
Add test module for CJK count transforms with tests:

Chinese @count tests:
- test_chinese_count_zhang: :zhang "牌" with context 3 -> "3张牌"
- test_chinese_count_ge: :ge "个" with context 5 -> "5个个" (hmm, need noun) -> actually :ge "角色" with 2 -> "2个角色"
- test_chinese_count_ming: :ming "玩家" with context 1 -> "1名玩家"
- test_chinese_count_missing_tag: phrase without classifier tag returns MissingTag error

Japanese @count tests:
- test_japanese_count_mai: :mai "カード" with context 3 -> "3枚カード"
- test_japanese_count_nin: :nin "キャラクター" with context 2 -> "2人キャラクター"
- test_japanese_count_missing_tag: phrase without counter tag returns MissingTag error

Korean @count tests:
- test_korean_count_jang: :jang "카드" with context 3 -> "3장카드"
- test_korean_count_myeong: :myeong "캐릭터" with context 2 -> "2명캐릭터"
- test_korean_count_missing_tag: phrase without counter tag returns MissingTag error

Use the established test pattern from existing transform tests:
- Create Value::Phrase with appropriate tags
- Call transform.execute() with context
- Assert result matches expected string
  </action>
  <verify>Run `just review` to verify all tests pass and code quality checks pass</verify>
  <done>All CJK @count tests passing, just review clean</done>
</task>

</tasks>

<verification>
1. `just check` passes (code compiles)
2. `just test` passes (all existing + new tests)
3. `just review` passes (formatting, clippy, tests)
4. Chinese @count produces "3张牌" for :zhang "牌" with count=3
5. Japanese @count produces "3枚カード" for :mai "カード" with count=3
6. Korean @count produces "3장카드" for :jang "카드" with count=3
7. All three transforms return MissingTag error when classifier/counter tag missing
</verification>

<success_criteria>
- Three CJK @count transforms implemented and registered
- hangeul dependency added (for Phase 9-03)
- All tests pass including new CJK count tests
- just review passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-asian-language-transforms/09-01-SUMMARY.md`
</output>
