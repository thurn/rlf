---
phase: 03-universal-transforms-and-icu4x
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/rlf/Cargo.toml
  - crates/rlf/src/interpreter/transforms.rs
  - crates/rlf/src/interpreter/error.rs
  - crates/rlf/src/interpreter/mod.rs
autonomous: true

must_haves:
  truths:
    - "@cap capitalizes first grapheme correctly for any Unicode input"
    - "@upper converts entire string to uppercase with locale awareness"
    - "@lower converts entire string to lowercase with locale awareness"
    - "Turkish 'istanbul' uppercases to 'ISTANBUL' with dotted capital I"
  artifacts:
    - path: "crates/rlf/src/interpreter/transforms.rs"
      provides: "TransformKind enum and case transform implementations"
      exports: ["TransformKind", "TransformRegistry"]
    - path: "crates/rlf/src/interpreter/error.rs"
      provides: "UnknownTransform error variant"
      contains: "UnknownTransform"
  key_links:
    - from: "crates/rlf/src/interpreter/transforms.rs"
      to: "icu_casemap::CaseMapper"
      via: "case transform implementations"
      pattern: "CaseMapper::new"
    - from: "crates/rlf/src/interpreter/transforms.rs"
      to: "unicode_segmentation"
      via: "grapheme iteration for @cap"
      pattern: "graphemes\\(true\\)"
---

<objective>
Implement TransformKind enum with universal case transforms (@cap, @upper, @lower) using ICU4X for locale-sensitive case mapping.

Purpose: Enable case transformations that work correctly across all languages, including Turkish dotted-I handling and proper Unicode grapheme awareness.

Output: TransformKind enum with Cap/Upper/Lower variants, case transform functions using ICU4X CaseMapper, updated TransformRegistry to use static dispatch.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-universal-transforms-and-icu4x/03-CONTEXT.md
@.planning/phases/03-universal-transforms-and-icu4x/03-RESEARCH.md
@crates/rlf/src/interpreter/transforms.rs
@crates/rlf/src/interpreter/error.rs
@crates/rlf/src/types/value.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ICU4X casemap and unicode-segmentation dependencies</name>
  <files>crates/rlf/Cargo.toml</files>
  <action>
Add the following dependencies to Cargo.toml:
- `icu_casemap = "2"` - For locale-sensitive case mapping (Turkish i/I handling)
- `unicode-segmentation = "1.12"` - For grapheme-aware @cap transform

These are required per RESEARCH.md findings:
- icu_casemap provides CaseMapper for correct Turkish dotted-I (istanbul -> ISTANBUL not ISTANBUL)
- unicode-segmentation provides graphemes() for proper first-character handling with combining characters
  </action>
  <verify>`cargo check -p rlf` compiles successfully with new dependencies</verify>
  <done>Both dependencies added and project compiles</done>
</task>

<task type="auto">
  <name>Task 2: Implement TransformKind enum and case transforms</name>
  <files>crates/rlf/src/interpreter/transforms.rs, crates/rlf/src/interpreter/error.rs, crates/rlf/src/interpreter/mod.rs</files>
  <action>
**In error.rs:**
Add UnknownTransform variant to EvalError:
```rust
#[error("unknown transform '@{name}'")]
UnknownTransform { name: String },
```

**In transforms.rs:**
Replace the current stub implementation with:

1. Add imports:
```rust
use icu_casemap::CaseMapper;
use icu_locale_core::{langid, LanguageIdentifier};
use unicode_segmentation::UnicodeSegmentation;
```

2. Create TransformKind enum (static dispatch per CONTEXT.md):
```rust
/// Transform types for static dispatch.
///
/// Per CONTEXT.md: static dispatch via enum, no trait objects or function pointers.
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum TransformKind {
    /// @cap - Capitalize first grapheme
    Cap,
    /// @upper - All uppercase
    Upper,
    /// @lower - All lowercase
    Lower,
}
```

3. Implement execute method on TransformKind:
```rust
impl TransformKind {
    /// Execute the transform on a value.
    ///
    /// Context is optional (used by language-specific transforms in later phases).
    /// Lang is used for locale-sensitive case mapping.
    pub fn execute(
        &self,
        value: &Value,
        _context: Option<&Value>,  // Unused for universal transforms
        lang: &str,
    ) -> Result<String, EvalError> {
        let text = value.to_string();
        let locale = parse_langid(lang);

        match self {
            TransformKind::Cap => cap_transform(&text, &locale),
            TransformKind::Upper => upper_transform(&text, &locale),
            TransformKind::Lower => lower_transform(&text, &locale),
        }
    }
}
```

4. Implement case transform functions:
```rust
/// Parse language code to ICU4X LanguageIdentifier.
///
/// Special handling for Turkish (tr) and Azerbaijani (az) which have
/// dotted-I case mapping rules different from other languages.
fn parse_langid(lang: &str) -> LanguageIdentifier {
    // Try to parse the language code, fall back to undetermined
    lang.parse().unwrap_or_else(|_| langid!("und"))
}

/// Capitalize first grapheme, preserving rest of string.
///
/// Uses unicode-segmentation for grapheme-aware first character detection.
/// Handles combining characters correctly (e.g., "e\u{0301}" is one grapheme).
fn cap_transform(text: &str, locale: &LanguageIdentifier) -> Result<String, EvalError> {
    if text.is_empty() {
        return Ok(String::new());
    }

    let cm = CaseMapper::new();
    let mut graphemes = text.graphemes(true);

    match graphemes.next() {
        Some(first) => {
            let rest: String = graphemes.collect();
            // Uppercase the first grapheme (handles multi-codepoint graphemes)
            let capitalized = cm.uppercase_to_string(first, locale);
            Ok(format!("{}{}", capitalized, rest))
        }
        None => Ok(String::new()),
    }
}

/// Convert entire string to uppercase.
fn upper_transform(text: &str, locale: &LanguageIdentifier) -> Result<String, EvalError> {
    let cm = CaseMapper::new();
    Ok(cm.uppercase_to_string(text, locale))
}

/// Convert entire string to lowercase.
fn lower_transform(text: &str, locale: &LanguageIdentifier) -> Result<String, EvalError> {
    let cm = CaseMapper::new();
    Ok(cm.lowercase_to_string(text, locale))
}
```

5. Update TransformRegistry to use TransformKind:
```rust
impl TransformRegistry {
    /// Create a new registry with universal transforms registered.
    pub fn new() -> Self {
        Self {
            universal: HashMap::new(),
            language_specific: HashMap::new(),
        }
    }

    /// Get a transform by name for a language.
    ///
    /// Resolution order:
    /// 1. Language-specific transforms (future phases)
    /// 2. Universal transforms (@cap, @upper, @lower)
    pub fn get(&self, name: &str, _lang: &str) -> Option<TransformKind> {
        // Universal transforms are always available
        match name {
            "cap" => Some(TransformKind::Cap),
            "upper" => Some(TransformKind::Upper),
            "lower" => Some(TransformKind::Lower),
            _ => None,  // Language-specific transforms added in Phases 6-9
        }
    }
}
```

Remove the old TransformFn type alias and update TransformRegistry fields to be simpler (we're now using TransformKind::get() pattern, not storing functions).

**In mod.rs:**
Export TransformKind from the interpreter module.
  </action>
  <verify>`just review` passes (check, format, clippy, tests)</verify>
  <done>TransformKind enum exists with Cap/Upper/Lower, case transforms use ICU4X CaseMapper with grapheme awareness, UnknownTransform error variant added</done>
</task>

</tasks>

<verification>
1. `cargo check -p rlf` compiles with new dependencies
2. `just review` passes all checks
3. TransformKind enum has Cap, Upper, Lower variants
4. EvalError has UnknownTransform variant
5. TransformRegistry::get() returns TransformKind for "cap", "upper", "lower"
</verification>

<success_criteria>
- icu_casemap and unicode-segmentation dependencies added
- TransformKind enum with Cap/Upper/Lower variants
- Case transform implementations using CaseMapper and graphemes()
- UnknownTransform error variant in EvalError
- TransformRegistry updated to return TransformKind
- All existing tests pass
- `just review` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-universal-transforms-and-icu4x/03-01-SUMMARY.md`
</output>
