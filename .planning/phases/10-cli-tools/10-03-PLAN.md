---
phase: 10-cli-tools
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - crates/rlf-cli/src/commands/coverage.rs
  - crates/rlf-cli/src/commands/mod.rs
  - crates/rlf-cli/src/main.rs
  - crates/rlf-cli/src/output/table.rs
  - crates/rlf-cli/src/output/mod.rs
  - crates/rlf-cli/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "User can run `rlf coverage --source en.rlf --lang es,fr` and see coverage table"
    - "Output shows absolute counts (17/20 phrases) not percentages"
    - "Missing phrase names are listed per language"
    - "`--strict` makes incomplete translations exit non-zero"
  artifacts:
    - path: "crates/rlf-cli/src/commands/coverage.rs"
      provides: "Coverage command implementation"
      contains: "pub fn run_coverage"
    - path: "crates/rlf-cli/src/output/table.rs"
      provides: "comfy-table coverage table formatting"
      contains: "format_coverage_table"
  key_links:
    - from: "crates/rlf-cli/src/commands/coverage.rs"
      to: "rlf::parser::parse_file"
      via: "parsing source and translation files"
      pattern: "parse_file"
    - from: "crates/rlf-cli/src/commands/coverage.rs"
      to: "crates/rlf-cli/src/output/table.rs"
      via: "format_coverage_table call"
      pattern: "format_coverage_table"
---

<objective>
Implement the `rlf coverage` subcommand for translation coverage reporting.

Purpose: Provide developers with visibility into translation completeness across languages, useful for tracking localization progress and CI enforcement.

Output: Working `rlf coverage` command that shows ASCII table with coverage stats and lists missing phrases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-cli-tools/10-CONTEXT.md
@.planning/phases/10-cli-tools/10-RESEARCH.md
@.planning/phases/10-cli-tools/10-01-SUMMARY.md
@.planning/phases/10-cli-tools/10-02-SUMMARY.md
@crates/rlf/src/lib.rs
@crates/rlf/src/parser/mod.rs
@crates/rlf/src/parser/ast.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comfy-table dependency and create table formatter</name>
  <files>
    crates/rlf-cli/Cargo.toml
    crates/rlf-cli/src/output/table.rs
    crates/rlf-cli/src/output/mod.rs
  </files>
  <action>
1. Add comfy-table to Cargo.toml:
   - comfy-table = "7"

2. Create output/table.rs with format_coverage_table function:
   - Input: source_count (usize), coverage data Vec<(String, usize, Vec<String>)>
     - Tuple is (language, translated_count, missing_phrases)
   - Create Table with UTF8_BORDERS_ONLY preset
   - Set ContentArrangement::Dynamic
   - Header: ["Language", "Coverage", "Missing"]
   - For each language row:
     - Language name
     - Coverage as "X/Y" (translated/total)
     - Missing count
   - Return Table (implements Display)

3. Update output/mod.rs:
   - Add pub mod table;
  </action>
  <verify>
`cargo check -p rlf-cli` compiles with comfy-table
  </verify>
  <done>
comfy-table added, table formatter ready for coverage command
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement coverage command</name>
  <files>
    crates/rlf-cli/src/commands/coverage.rs
    crates/rlf-cli/src/commands/mod.rs
    crates/rlf-cli/src/main.rs
  </files>
  <action>
1. Create commands/coverage.rs:

CoverageArgs struct with clap::Args derive:
- --source <file> (required): PathBuf to source language file
- --lang <langs> (required, value_delimiter = ','): Vec<String> of language codes
- --translations <dir> (optional): Directory containing translation files
- --strict flag: Exit non-zero if any translation incomplete
- --json flag: JSON output mode

2. Implement run_coverage(args: CoverageArgs) -> miette::Result<i32>:

a) Parse source file to get phrase names:
   - Read source file with std::fs::read_to_string
   - Parse with rlf::parser::parse_file
   - Extract phrase names into Vec<String>
   - Handle errors with miette

b) For each language in args.lang:
   - Determine translation file path:
     - If --translations dir: dir/lang.rlf
     - Otherwise: source.parent()/lang.rlf (sibling to source)
   - If file exists:
     - Parse and extract translated phrase names
     - Compute missing = source_names - translated_names (set difference)
   - If file doesn't exist:
     - All phrases missing
   - Store (lang, translated_count, missing_names)

c) Check for incomplete translations:
   - any_incomplete = any language has missing phrases

d) Output:
   - JSON mode:
     - Array of objects: { language, translated, total, missing[] }
     - Use serde_json::to_string_pretty
   - Human mode:
     - Print coverage table using format_coverage_table
     - For each language with missing phrases:
       - Print "\nMissing in {lang}:"
       - List each missing phrase with "  - {name}"

e) Return exit code:
   - If --strict and any_incomplete: exitcode::DATAERR
   - Otherwise: exitcode::OK

3. Update commands/mod.rs:
   - Add coverage module
   - Add Coverage(CoverageArgs) to Commands enum

4. Update main.rs dispatch:
   - Add Commands::Coverage(args) => commands::coverage::run_coverage(args)
  </action>
  <verify>
```bash
# Create source and translation files
echo 'greeting = "Hello";
farewell = "Goodbye";
thanks = "Thank you";' > /tmp/en.rlf

echo 'greeting = "Hola";
farewell = "Adios";' > /tmp/es.rlf

echo 'greeting = "Bonjour";' > /tmp/fr.rlf

# Test coverage
cargo run -p rlf-cli -- coverage --source /tmp/en.rlf --lang es,fr

# Expected output: ASCII table showing es: 2/3, fr: 1/3 + missing lists

# Test JSON output
cargo run -p rlf-cli -- coverage --source /tmp/en.rlf --lang es --json

# Test --strict (should exit non-zero)
cargo run -p rlf-cli -- coverage --source /tmp/en.rlf --lang es --strict
echo "Exit: $?"

# Test help
cargo run -p rlf-cli -- coverage --help
```
  </verify>
  <done>
Coverage command shows translation completeness, lists missing phrases, supports --strict for CI, outputs JSON or ASCII table.
  </done>
</task>

</tasks>

<verification>
Run complete test sequence:
```bash
# Setup test files
mkdir -p /tmp/rlf-test
echo 'a = "A";
b = "B";
c = "C";
d = "D";
e = "E";' > /tmp/rlf-test/en.rlf

echo 'a = "A-es";
b = "B-es";
c = "C-es";' > /tmp/rlf-test/es.rlf

echo 'a = "A-fr";' > /tmp/rlf-test/fr.rlf

# Test basic coverage (should show table)
cargo run -p rlf-cli -- coverage --source /tmp/rlf-test/en.rlf --lang es,fr

# Expected:
# | Language | Coverage | Missing |
# |----------|----------|---------|
# | es       | 3/5      | 2       |
# | fr       | 1/5      | 4       |
#
# Missing in es:
#   - d
#   - e
#
# Missing in fr:
#   - b
#   - c
#   - d
#   - e

# Test --strict exits non-zero when incomplete
cargo run -p rlf-cli -- coverage --source /tmp/rlf-test/en.rlf --lang es --strict
echo "Exit code (expect 65): $?"

# Test with full coverage (create complete translation)
cp /tmp/rlf-test/en.rlf /tmp/rlf-test/de.rlf
cargo run -p rlf-cli -- coverage --source /tmp/rlf-test/en.rlf --lang de --strict
echo "Exit code (expect 0): $?"

# Test JSON output
cargo run -p rlf-cli -- coverage --source /tmp/rlf-test/en.rlf --lang es --json

# Test missing translation file
cargo run -p rlf-cli -- coverage --source /tmp/rlf-test/en.rlf --lang it
# Should show 0/5 coverage, all phrases missing
```
</verification>

<success_criteria>
- CLI-09: --source specifies source language file
- CLI-10: --lang accepts comma-separated language list
- CLI-11: Output table shows phrases, translated, missing counts (absolute, not percentage)
- CLI-12: Lists missing phrase names per language
- --strict flag makes incomplete translations exit non-zero for CI
- JSON output mode works
- Missing translation file handled gracefully (0% coverage)
</success_criteria>

<output>
After completion, create `.planning/phases/10-cli-tools/10-03-SUMMARY.md`
</output>
